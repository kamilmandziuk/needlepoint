================================================================================
NEEDLEPOINT - Implementation State
Last Updated: 2025-12-27
================================================================================

PROJECT OVERVIEW
----------------
Needlepoint is a graph-based LLM code orchestration platform built with:
- Backend: Rust + Tauri 2.0
- Frontend: React 18 + TypeScript + Vite
- Graph Visualization: @xyflow/react v12
- State Management: Zustand
- Code Editor: Monaco Editor
- Styling: Tailwind CSS

The application allows users to define software architecture as a directed graph
where each node represents a code file with metadata, and edges represent
dependencies. LLM instances can generate code for nodes based on their
descriptions and dependency context.

================================================================================
IMPLEMENTATION STATUS
================================================================================

PHASE 1: Foundation - COMPLETE
- Tauri + React project initialized
- Core Rust data structures (Node, Edge, Project)
- YAML serialization/deserialization
- Tauri commands: load_project, save_project
- ReactFlow graph visualization
- Basic node rendering

PHASE 2: Graph Editing - COMPLETE
- Node CRUD operations (create, edit, delete)
- Edge operations (connect, delete, edit label)
- Context menus for nodes and edges
- Keyboard shortcuts (Delete/Backspace)
- Cycle detection (frontend DFS + backend petgraph)
- Validation indicators (orphan nodes, missing metadata)
- Node metadata editor (General, LLM Config, Code tabs)

PHASE 3: LLM Integration - COMPLETE
- LLM Provider abstraction layer (trait-based)
- Anthropic Claude API implementation
- OpenAI API implementation
- Ollama local LLM implementation
- Context builder (assembles prompts from graph dependencies)
- Generation commands (generate_node, preview_prompt)
- Monaco editor for code preview/editing
- Prompt preview feature
- Settings panel for API key management
- Persistent API key storage (tauri-plugin-store)

PHASE 4: Parallel Orchestration - COMPLETE
- Topological sort for dependency ordering (Kahn's algorithm)
- Wave-based execution plan (nodes grouped by dependency level)
- Task executor with concurrent generation (tokio + futures)
- Real-time progress via Tauri events
- Execution monitor UI with progress bar and live logs
- Context-aware generation (includes actual generated code from dependencies)
- Automatic markdown code block stripping from LLM output
- Flexible edge labels (free-form text instead of fixed types)
- Edge editor panel in properties sidebar

PHASE 5: UX & Safety - COMPLETE
- Resizable and collapsible panels (both left and right)
- Multi-selection with bulk delete
- Toast notifications for user feedback
- Selection persistence when moving nodes
- File tree panel showing project structure
- Auto-save (no manual save button in editor)
- File system integration (create/rename/delete files with nodes)
- Path sanitization (prevents directory traversal attacks)
- Soft delete with trash folder (.needlepoint/trash/)
- Duplicate path detection with auto-increment for new nodes
- Undo/redo for deleted nodes (Ctrl+Z/Ctrl+Y)
- Global keyboard shortcuts (Ctrl+S save, Ctrl+A select all)
- Confirmation dialog for multi-node delete only

PHASE 6: CLI & Agent Integration - COMPLETE
- HTTP API server (axum) running alongside Tauri app on port 9999
- Full REST API for project operations:
  - GET /api/status - health check and server info
  - GET /api/project - get current project
  - POST /api/project/load - load project from file path
  - POST /api/project/save - save current project
  - GET/POST/PUT/DELETE /api/nodes - node CRUD operations
  - GET/POST/DELETE /api/edges - edge operations
  - POST /api/generate/:id - generate code for a node
  - POST /api/generate-all - generate all nodes
  - GET /api/execution-plan - get dependency-ordered execution plan
  - GET /api/prompt/:id - preview prompt for a node
  - POST /api/api-keys - set LLM provider API keys
- needlepoint-cli binary for command-line control:
  - status, load, save, nodes, node, edges, plan, prompt
  - generate, generate-all, set-keys, project
- "Launch Agent" button in GUI to open project folder
- Shared state between GUI and HTTP API

PHASE 7: Polish & Advanced Features - NOT STARTED
- Project templates
- Validation hooks (compile/lint checks)
- Git integration
- Settings & themes
- Incremental generation (only regenerate changed nodes)
- MCP server implementation (for direct Claude Code integration)
- Embedded terminal (xterm.js)

================================================================================
KEY FILES - BACKEND (src-tauri/src/)
================================================================================

main.rs
  - Tauri entry point
  - Registers plugins: shell, dialog, store
  - Registers all command handlers
  - Starts HTTP API server in background on port 9999

api/
  mod.rs           - HTTP server startup (axum), CORS configuration
  state.rs         - Shared AppState (project, API keys, port)
  routes.rs        - All REST API route handlers

bin/
  cli.rs           - needlepoint-cli binary (clap-based CLI)

commands/
  mod.rs           - Module exports
  api.rs           - get_api_port command for frontend
  project.rs       - load_project, save_project commands
  graph.rs         - add_node, update_node, delete_node, add_edge, delete_edge,
                     check_would_create_cycle
  generation.rs    - generate_node(project, node_id, api_key), preview_prompt
  orchestration.rs - get_execution_plan, generate_all, generate_nodes
  filesystem.rs    - File operations with path validation:
                     create_file, write_file, delete_file (soft),
                     delete_file_permanent, restore_file, list_trash,
                     empty_trash, rename_file, file_exists, create_directory

graph/
  mod.rs           - Module exports
  model.rs         - Core data structures: CodeNode, CodeEdge, Project,
                     LLMConfig, ExportSignature, Language, NodeStatus
  serialization.rs - YAML read/write functions
  validation.rs    - Cycle detection, validation

llm/
  mod.rs           - Module exports + create_provider() factory function
  provider.rs      - LLMProvider trait, GenerationRequest, GenerationResponse,
                     LLMError types
  anthropic.rs     - AnthropicProvider implementation (Claude API)
  openai.rs        - OpenAIProvider implementation (OpenAI API)
  ollama.rs        - OllamaProvider implementation (local Ollama)
  context.rs       - ContextBuilder: builds prompts from node metadata and
                     graph dependencies, includes generated code from deps,
                     strip_code_blocks() for cleaning LLM output

orchestration/
  mod.rs           - Module exports
  planner.rs       - ExecutionPlan, ExecutionWave, topological sort
  executor.rs      - Executor: concurrent wave-based generation
  events.rs        - ExecutionEvent types for Tauri event streaming

Cargo.toml dependencies:
  - tauri, tauri-plugin-shell, tauri-plugin-dialog, tauri-plugin-store
  - serde, serde_yaml, serde_json
  - tokio, reqwest, async-trait, futures
  - uuid, petgraph, anyhow, thiserror, regex, chrono
  - axum, tower-http (HTTP API server)
  - clap (CLI argument parsing)

================================================================================
KEY FILES - FRONTEND (src/)
================================================================================

App.tsx
  - Root component
  - Manages settings panel and execution monitor visibility
  - Loads settings on startup
  - Initializes global keyboard shortcuts

main.tsx
  - React entry point

lib/
  types.ts         - TypeScript types matching Rust structs, includes
                     ExecutionPlan, ExecutionEvent, NodeProgress
  tauri.ts         - IPC command wrappers including file operations,
                     validateFilePath() for frontend path validation,
                     getApiPort() for HTTP API integration
  fileTree.ts      - Utilities for building file tree from nodes

hooks/
  useKeyboardShortcuts.ts - Global keyboard shortcuts:
                            Ctrl+Z (undo), Ctrl+Y (redo), Ctrl+S (save),
                            Ctrl+A (select all)

stores/
  projectStore.ts  - Zustand store for project state:
                     - Multi-selection (selectedNodeIds array)
                     - Cycle detection
                     - File operations on node changes
                     - Duplicate path detection with auto-increment
                     - restoreDeletedNodes/reDeleteNodes for undo/redo
  settingsStore.ts - Zustand store for settings, uses tauri-plugin-store
  executionStore.ts - Zustand store for execution state, progress tracking
  toastStore.ts    - Toast notification store (success, error, info)
  undoStore.ts     - Undo/redo stack for delete operations

components/
  layout/
    LeftPanel.tsx        - Collapsible & resizable left panel with:
                           toolbar (New, Open, Save, Settings), file tree,
                           Launch Agent button, Generate All button
    Canvas.tsx           - Main graph canvas area
    PropertiesPanel.tsx  - Right panel showing selected node or edge editor
    ResizablePanel.tsx   - Reusable resizable & collapsible panel wrapper
                           with toolbar slot
    RightPanelToolbar.tsx - Toolbar for right panel with Generate, Stop,
                            Delete buttons (context-aware for node/edge)

  graph/
    GraphCanvas.tsx     - ReactFlow wrapper with context menus, keyboard
                          shortcuts, multi-selection, confirmation dialog
    CodeNode.tsx        - Custom node component with status colors and
                          validation badge (warnings only)
    DependencyEdge.tsx  - Custom edge component with wrapping labels
    ContextMenu.tsx     - Right-click context menu for nodes/edges

  filetree/
    FileTree.tsx        - File tree component showing project structure,
                          collapsible folders, status colors

  editor/
    NodeEditor.tsx      - Tabbed editor (General, LLM Config, Code)
                          No header, tabs-only layout
    EdgeEditor.tsx      - Edge properties editor with connection info,
                          label input, and quick templates
    LLMConfigEditor.tsx - Editor for LLM provider, model, constraints
    CodePreview.tsx     - Monaco editor with code/prompt tabs

  execution/
    ExecutionMonitor.tsx - Modal with progress bar, wave status, live logs

  settings/
    SettingsPanel.tsx   - Modal for API key configuration

  ui/
    Toast.tsx           - Toast notification component
    ConfirmDialog.tsx   - Reusable confirmation dialog

================================================================================
CONFIGURATION FILES
================================================================================

src-tauri/tauri.conf.json
  - App configuration (window size, plugins, etc.)
  - Plugins enabled: shell, store

src-tauri/capabilities/default.json
  - Permissions: core:default, shell:allow-open, dialog:allow-open,
    dialog:allow-save, store:allow-get, store:allow-set, store:allow-save,
    store:allow-load

package.json dependencies:
  - @tauri-apps/api, @tauri-apps/plugin-dialog, @tauri-apps/plugin-shell,
    @tauri-apps/plugin-store
  - @xyflow/react, @monaco-editor/react
  - react, react-dom
  - zustand, lucide-react

tailwind.config.js
  - Custom colors for canvas background, node states
  - Animation for toast slide-in

================================================================================
RECENT CHANGES (Phase 5: UX & Safety)
================================================================================

1. Panel System:
   - LeftPanel: Replaced Sidebar, now collapsible AND resizable (180-400px)
   - ResizablePanel: Reusable component with toolbar slot, collapse button
   - Right panel: Collapsible with toolbar containing action buttons
   - Consistent collapse button styling between panels

2. File System Integration:
   - Files created on disk when nodes are added
   - Files renamed when node paths change
   - Files soft-deleted (moved to .needlepoint/trash/) when nodes deleted
   - Path validation prevents directory traversal attacks
   - Duplicate path detection with auto-increment (file.ts -> file-1.ts)

3. Undo/Redo System:
   - undoStore tracks deleted nodes with edges and trash filenames
   - Ctrl+Z restores deleted nodes (files restored from trash)
   - Ctrl+Y re-deletes previously restored nodes
   - Max 50 entries in undo stack

4. Multi-Selection:
   - selectedNodeIds array instead of single selectedNodeId
   - Shift+click and drag-select for multiple nodes
   - Bulk delete with confirmation dialog (single delete has no dialog)
   - Selection persists when dragging nodes

5. UI Cleanup:
   - Removed Exports tab (redundant, auto-detected from code)
   - Removed exports display from CodeNode
   - Auto-save: onChange handlers instead of react-hook-form
   - Toast notifications for save/restore/delete feedback
   - Consistent text sizing in EdgeEditor
   - Toolbar in right panel header (collapse left, actions right)

================================================================================
KEYBOARD SHORTCUTS
================================================================================

Global (useKeyboardShortcuts hook):
  Ctrl+Z        - Undo (restore deleted nodes)
  Ctrl+Y        - Redo (re-delete nodes)
  Ctrl+Shift+Z  - Redo (alternative)
  Ctrl+S        - Save project
  Ctrl+A        - Select all nodes (when not in input field)

Local (GraphCanvas):
  Delete        - Delete selected nodes/edge
  Backspace     - Delete selected nodes/edge
  Escape        - Deselect all, close context menu

Future (see HOTKEY_SUGGESTIONS.txt):
  Ctrl+D, Ctrl+N, F2, F5, Ctrl+0, etc.

================================================================================
HOW TO RUN
================================================================================

Development:
  cd needlepoint
  npm run tauri dev

Build:
  cd needlepoint
  npm run tauri build

Build CLI only:
  cd src-tauri
  cargo build --bin needlepoint-cli --release

================================================================================
CLI USAGE
================================================================================

The CLI communicates with the running Needlepoint app via HTTP API (port 9999).

Commands:
  needlepoint-cli status              # Check if Needlepoint is running
  needlepoint-cli load <path>         # Load a project from YAML file
  needlepoint-cli save                # Save current project
  needlepoint-cli nodes               # List all nodes
  needlepoint-cli node <id>           # Get details of a node
  needlepoint-cli edges               # List all edges
  needlepoint-cli plan                # Show execution plan (dependency order)
  needlepoint-cli prompt <id>         # Preview prompt for a node
  needlepoint-cli generate <id>       # Generate code for a node
  needlepoint-cli generate-all        # Generate code for all nodes
  needlepoint-cli set-keys --anthropic <key>  # Set API keys
  needlepoint-cli project             # Get full project as JSON

Options:
  -p, --port <PORT>   # Use different port (default: 9999)

Using with Claude Code:
  1. Start Needlepoint GUI (npm run tauri dev)
  2. Load or create a project in the GUI
  3. Open a terminal in the project folder (Launch Agent button)
  4. Run 'claude' to start Claude Code
  5. Claude Code can use the CLI to interact with the project

================================================================================
HOW TO TEST FEATURES
================================================================================

File System:
1. Create a new project (select empty folder)
2. Add nodes - files should appear in folder
3. Rename node file path - file should rename
4. Delete node - file moves to .needlepoint/trash/
5. Ctrl+Z - node and file restored

Undo/Redo:
1. Create several nodes
2. Delete a node (single or multi-select)
3. Press Ctrl+Z - node restored
4. Press Ctrl+Y - node deleted again

Multi-Selection:
1. Shift+click multiple nodes, or drag-select
2. Press Delete - confirmation dialog appears
3. Confirm - all selected nodes deleted
4. Ctrl+Z - all nodes restored at once

CLI & HTTP API:
1. Start Needlepoint (npm run tauri dev)
2. In a separate terminal: needlepoint-cli status
3. Should show "Status: ok" and "Project: none loaded"
4. Open a project in the GUI
5. Run: needlepoint-cli nodes - should list the project nodes
6. Run: needlepoint-cli plan - should show execution order

================================================================================
NEXT STEPS (Phase 7: Polish & Advanced Features)
================================================================================

1. MCP server implementation (direct Claude Code tool integration)
2. Embedded terminal (xterm.js) for agent interaction
3. Project templates (starter graphs for common architectures)
4. Validation hooks (run compile/lint after generation)
5. Git integration (commit generated code)
6. Settings & themes (dark/light mode, custom colors)
7. Incremental generation (track changes, only regenerate affected nodes)
8. Streaming support (show generation progress character-by-character)
9. Additional keyboard shortcuts (see HOTKEY_SUGGESTIONS.txt)

================================================================================
KNOWN ISSUES / WARNINGS
================================================================================

- Rust warnings about unused code (expected - functions for later phases)
- No streaming support yet (responses come all at once)
- No validation/compile checks after generation
- Cancel button in execution monitor doesn't actually cancel in-flight requests
- Stop button in right panel toolbar is placeholder only

================================================================================
GIT REPOSITORY
================================================================================

Remote: git@github.com-personal:kamilmandziuk/needlepoint
Branch: main
License: AGPL

================================================================================
